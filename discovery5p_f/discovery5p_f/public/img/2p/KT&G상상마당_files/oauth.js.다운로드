var device = '';
//var count = getCookie('count');
//var media = getCookie('media');
function selfProfileRegist(res){	//self창으로 콜백 받을때
    $.ajax({
            url: "/oauth/regist",
            type: "post",
            async: false,
            data: res,
            success: function () {
            	
            	setCookie('media', res.media);
            	getToken(res);
                selfCloseWindow();
            },
            error: function (xhr, ajaxOptions, thrownError) {
              //      alert(xhr.status+', '+thrownError);
            }
    });
}
function locationProfileRegist(res){	//self창으로 콜백 받을때_페이지 이동처리
    $.ajax({
            url: "/oauth/regist",
            type: "post",
            async: false,
            data: res,
            success: function () {
            	
            	setCookie('media', res.media);
            	getToken(res);
            	window.location.replace("/");
            },
            error: function (xhr, ajaxOptions, thrownError) {
              //      alert(xhr.status+', '+thrownError);
            }
    });
}
function profileRegist(res){		//새창으로 콜백받을때
    $.ajax({
            url: "/oauth/regist",
            type: "post",
            async: false,
            data: res,
            success: function () {
            		setCookie('media', res.media);
            		opener.getToken(res);
                    closeWindow();
            },
            error: function (xhr, ajaxOptions, thrownError) {
              //      alert(xhr.status+', '+thrownError);
            }
    });
}
function refresh() {
    var sURL = unescape('//'+document.domain);
    window.location.replace(sURL);
}
function closeWindow() {
	if (device=='ssmdapp_ios') {
       setTimeout( "refresh()", 150 );
    } else {
       opener.screen();
       window.close();
    }
}
function selfCloseWindow() {
	if (device=='ssmdapp_ios') {
       setTimeout( "refresh()", 150 );
    } else {
       screen();
    }
}
function getToken(res){
	if(device=='ssmdapp_aos'){
		saveToken();
		window.ssmd.getToken(res.snsId);
	}else if(device=='ssmdapp_ios'){
		saveToken();
		getIosToken(res.snsId);
	}
}
function getIosToken(sns_id){
    location.href = 'ssmd://getToken?usrid='+sns_id;
}
function saveToken(){
				   
	if(getCookie('token')!="" && typeof getCookie('token') != 'undefined' && getCookie('token')!="undefined"){
									   
		localStorage.token = getCookie('token');
										
	}
}
function loadToken(){
	if(localStorage.token != undefined && localStorage.token !='' && localStorage.token != 'undefined' ){
												  
		setCookie('token', localStorage.token, 1);
	}	
}
function deleteToken(){
	if(localStorage.token != undefined ){
		localStorage.token = '';
	}	
}


function getUserId(){
	if(device=='ssmdapp_aos' || device == 'ssmdapp_ios'){
		loadToken();
	}
	if(!checkAuth()){
		if(getCookie('count') == undefined || getCookie('count') == "" || getCookie('count') == 0){
			showLogin();
			setCookie('count', 1);
		}
	}else{
		var usrid = '';
		$.ajax({
			url:'/usr/userId',
			type:'post',
			async: false,
			dataType: 'text',
			success:function(data){
				usrid = data;
			}
		})
		
		if(device=='ssmdapp_aos'){
			window.ssmd.setUserId(usrid);
		}else if(device=='ssmdapp_ios'){
			location.href='ssmd://setUserId?usrid='+usrid;
		}
		$('#popcall--login').hide();
		$('#popcall--logout').show();
		setLoginKind(getCookie("media"));
	}
}
function setToken(token, os, sns_id){
	var res = {
		token : token,
		os : os,
		id : sns_id
	}
	appInfoRegist(res);
}

function appInfoRegist(res){
	$.ajax({
		url: "/oauth/appinfo",
		type: "post",
		async: false,
		data: res,
		success: function () {
		},
		error: function (xhr, ajaxOptions, thrownError) {
		//	alert(xhr.status+', '+thrownError);
		}
	});
	
}
var callbackFunction;
function checkAuth(callback){
	var result = false; 
	var token = $.cookie('token');
	if(token == null || token == ''){
		if(typeof callback != 'undefined'){
			openLoginPop(callback);
		}
		return false;
	}
		

	$.ajax({
		url:'/check/auth',
		type: 'post',
		async:false,
		data: {token:token},
		dataType : 'json',
		success:function(data){
			if(data.status=='true')
				result = true;
		},
		error: function (xhr, ajaxOptions, thrownError) {
			console.log(xhr.status+', '+thrownError);
		}
	});

	if(typeof callback != 'undefined'){
		if(!result){
			openLoginPop(callback);
		}
	}
	
	return result;
}
function openLoginPop(callback){
	if(confirm('로그인이 필요한 페이지 입니다.\n로그인 하시겠습니까??')){
		callbackFunction = callback;
		$("#popLogin").bPopup({
            positionStyle: 'fixed',
			speed: 500,
			transition: 'slideDown',
			transitionClose: 'slideDown'
		});
	}
}
function logoutProc(){
	var token = $.cookie('token');
	if(token!=null || token!=''){
		$.ajax({
			url:'/check/logout',
			type: 'post',
			data: {token:token},
			dataType : 'json',
			success:function(data){
				deleteToken();
				if(data.status=='true'){
					$('#popcall--login').show();
					$('#popcall--logout').hide();
					setCookie('count', '');
					setCookie('media', '');
					$.removeCookie('token');
					$('#allMenuGnb').bPopup({
						speed: 400,
						transition: 'slideIn',
						transitionClose: 'slideIn'
					}).close();
					$("body").css({"height": "auto"}).removeClass("overhd");
					$("#allMenuGnb").attr("data-allgnb","close");
				}else{
					setCookie('count', '');
					setCookie('media', '');
					$.removeCookie('token');
					
				}
				if(device=="ssmdapp_ios"){
					location.href='ssmd://snsLogout'
	            }else if(device=="ssmdapp_aos"){
	            		window.ssmd.snsLogout();
	            }
			},
			error: function (xhr, ajaxOptions, thrownError) {
				console.log(xhr.status+', '+thrownError);
			}
		});
	}
}

function naverLogin() {
    $("#naver_id_login_anchor").trigger("click");
}
function screen(){
	$('#popcall--login').hide();
	$('#popcall--logout').show();
	setLoginKind(getCookie('media'));
	if(typeof callbackFunction != 'undefined' && callbackFunction != '')
		callbackFunction();
	$("#popLogin").bPopup().close();
}
function showLogin(){
	$("#popLogin").bPopup({
        positionStyle: 'fixed',
		speed: 500,
		transition: 'slideDown',
		transitionClose: 'slideDown'
	});
}


$(document).ready(function(){
	
	$("#popcall--logout").bind('click',function(e) {
		// Prevents the default action to be triggered.
		e.preventDefault();
		logoutProc();
	});
	if(checkAuth()){
		$('#popcall--login').hide();
		$('#popcall--logout').show();
		setLoginKind(getCookie('media'));
	}
	
	device = getParseQueryValue(location.search, 'ssmdapp', '&');
	
	if(device!=""){
        setCookie('ssmdapp', device);
	}
	
	if(device==""){
		if(typeof getCookie('ssmdapp')!='undefined' && getCookie('ssmdapp')!=""){
			device = getCookie('ssmdapp');
			$('#appbtn').show();
			$('#appDisplay').show();
			$("li[name='appDisplay']").show();
		}else{
			$('#appbtn').hide();
			$('#appDisplay').hide();
			$("li[name='appDisplay']").hide();
		}
	}else{
		$('#appbtn').show();
		$('#appDisplay').show();
		$("li[name='appDisplay']").show();
	}

});

function getAppVersion(os)
{
	
	var ios_version = '1.0.8';
	var aos_version = '1.0.7';
	if(device=="ssmdapp_aos"){
	//	window.ssmd.setAppVersion(aos_version);
	}else if(device=="ssmdapp_ios"){
	//	location.href = 'ssmd://setAppVersion?code='+ios_version;
	}
}


function movePage(url, target, option){
	target = target.toLocaleLowerCase();
	
	if(device=="ssmdapp_aos"){
		if(target=="y"){
			window.ssmd.callBrowser(url);
		}else if(target=="n"){
			location.href=url;
		}
	}else if(device=="ssmdapp_ios"){
		if(target=="y"){
			location.href='ssmd://callBrowser?url='+url;
		}else if(target=="n"){
			location.href=url;
		}
	}else{
		if(target=="y"){
			if(typeof option=='undefined'){
				window.open(url, '새창');
			}else{
				window.open(url, '새창',option);
			}
		}else if(target=="n"){
			location.href=url;
		}
	}
}

function getParseQueryValue(q, key, delimiter) {
	
	if(q.indexOf(key) < 0) return '';

	var s_idx = q.indexOf(key+'=') + (key.length + 1);
	var value = q.substr(s_idx, q.length - s_idx);
	var e_idx = s_idx + value.indexOf(delimiter);

	if(e_idx >= s_idx) {
		value = q.substr(s_idx, e_idx - s_idx);
	}

	return value;
}
function getCookie(name) {
	var cookieValue = getParseQueryValue(document.cookie,name,';');
	
	if(cookieValue !== undefined && cookieValue !== '') {
		return getParseQueryValue(document.cookie,name,';');
	}else {
		return;
	}
}

function setCookie(name, value, type) {
	if(typeof type == "undefined" ){
		var todayDate = new Date();
		todayDate.setMonth(todayDate.getMonth() + 36);
		document.cookie = name + '=' + value + '; path=/; expires=' + todayDate + ';';
												  
	}else{
							 
		document.cookie = name + '=' + value + '; path=/;';
	}
}

function multiDomain(dd) {
	var s = dd.split(".");
	if (s.length == 3) {
		if (s[1].length == 2) {
			return dd;
		} else {
			return s[1] + "." + s[2];
		}
	} else if (s.length > 3) {
		if (s[s.length-2].length == 2) {
			return s[s.length-3] + "." + s[s.length-2] + "." + s[s.length-1];
		} else {
			return s[s.length-2] + "." + s[s.length-1];
		}
	} else {
		return dd;
	}
}

function setGoogleId(snsid){
	var res = {
		snsId : snsid,
		media : 'google'
	};
	selfProfileRegist(res);
}

function setLoginKind(media){
	 
	if(media=="naver"){
		
		$('#loginFacebook').hide();
		$('#loginNaver').show();
		$('#loginKakao').hide();
		$('#loginGoogle').hide();
		
	}else if(media=="kakao"){
		
		$('#loginFacebook').hide();
		$('#loginNaver').hide();
		$('#loginKakao').show();
		$('#loginGoogle').hide();
		
	}else if(media=="facebook"){
		
		$('#loginFacebook').show();
		$('#loginNaver').hide();
		$('#loginKakao').hide();
		$('#loginGoogle').hide();
		
	}else if(media=="google"){
		
		$('#loginFacebook').hide();
		$('#loginNaver').hide();
		$('#loginKakao').hide();
		$('#loginGoogle').show();
		
	}
}
